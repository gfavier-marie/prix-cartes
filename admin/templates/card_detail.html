{% extends "base.html" %}

{% block title %}{{ card.effective_name }}{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6">
    <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
        <div>
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white flex items-center gap-3 flex-wrap">
                {{ card.effective_name }}
                {% if card.name_override %}
                <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400">Override</span>
                {% endif %}
            </h1>
            <p class="mt-1 font-mono text-sm text-gray-500 dark:text-gray-400">{{ card.tcgdex_id }}</p>
        </div>
        <a href="{{ back_url | default(url_for('cards_list')) }}" class="inline-flex items-center gap-2 px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
            Retour
        </a>
    </div>
</div>

<!-- Action Buttons -->
<div class="flex flex-wrap gap-3 mb-6">
    <a href="{{ url_for('card_edit', card_id=card.id) }}" class="inline-flex items-center gap-2 px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white text-sm font-medium rounded-lg transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
        Editer la requete
    </a>
    <form method="POST" action="{{ url_for('card_reprocess', card_id=card.id) }}{% if back_params %}?{{ back_params }}{% endif %}" class="inline">
        <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Collecter eBay
        </button>
    </form>
    {% if card.effective_ebay_query %}
    <a href="https://www.ebay.fr/sch/i.html?_nkw={{ card.effective_ebay_query | urlencode }}&_sacat=183454" target="_blank" rel="noopener" class="inline-flex items-center gap-2 px-4 py-2 bg-[#0064d2] hover:bg-[#0054b8] text-white text-sm font-medium rounded-lg transition-colors">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        eBay
    </a>
    {% endif %}
</div>

<!-- Card Info -->
<div class="bg-white dark:bg-dark-700 rounded-xl border border-gray-200 dark:border-dark-500 p-6 mb-6">
    <div class="flex flex-col sm:flex-row gap-6">
        <div class="shrink-0">
            <img src="{{ card.image_url }}" alt="{{ card.name }}" class="w-36 sm:w-44 rounded-lg shadow-lg" loading="lazy" onerror="this.style.display='none'">
        </div>
        <div class="flex-1">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Informations</h2>
            <dl class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div class="flex justify-between sm:block">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Set</dt>
                    <dd class="text-sm font-medium text-gray-900 dark:text-white">{{ card.effective_set_name }}{% if card.set_name_override %} <span class="text-[10px] px-1.5 py-0.5 rounded bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400">Override</span>{% endif %}</dd>
                </div>
                <div class="flex justify-between sm:block">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Numero</dt>
                    <dd class="text-sm font-medium font-mono text-gray-900 dark:text-white">{{ card.effective_local_id }}{% if card.local_id_override %} <span class="text-[10px] px-1.5 py-0.5 rounded bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400">Override</span>{% endif %}</dd>
                </div>
                <div class="flex justify-between sm:block">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Variant</dt>
                    <dd><span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 dark:bg-dark-500 text-gray-600 dark:text-gray-300">{{ card.variant.value if card.variant else 'NORMAL' }}</span></dd>
                </div>
                <div class="flex justify-between sm:block">
                    <dt class="text-sm text-gray-500 dark:text-gray-400">Rarete</dt>
                    <dd class="text-sm font-medium text-gray-900 dark:text-white">{{ card.rarity or '-' }}</dd>
                </div>
            </dl>
        </div>
    </div>
</div>

<!-- Edit Form -->
<div class="bg-white dark:bg-dark-700 rounded-xl border border-gray-200 dark:border-dark-500 p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Personnaliser</h2>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">Ces valeurs remplacent TCGdex. Vide = valeur TCGdex.</p>
    <form id="card-info-form">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
                <label for="name_override" class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1.5">Nom</label>
                <input type="text" id="name_override" value="{{ card.name_override or '' }}" placeholder="{{ card.name }}" class="w-full px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-200 dark:border-dark-500 rounded-lg text-sm text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500">
                <p class="mt-1 text-[11px] text-gray-400">TCGdex: {{ card.name }}</p>
            </div>
            <div>
                <label for="local_id_override" class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1.5">Numero</label>
                <input type="text" id="local_id_override" value="{{ card.local_id_override or '' }}" placeholder="{{ card.local_id }}" class="w-full px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-200 dark:border-dark-500 rounded-lg text-sm text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="set_name_override" class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1.5">Serie</label>
                <input type="text" id="set_name_override" value="{{ card.set_name_override or '' }}" placeholder="{{ card.set_name }}" class="w-full px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-200 dark:border-dark-500 rounded-lg text-sm text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="card_count_official_override" class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1.5">Total set</label>
                <input type="text" id="card_count_official_override" value="{{ card.card_count_official_override or '' }}" class="w-full px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-200 dark:border-dark-500 rounded-lg text-sm text-gray-900 dark:text-white placeholder-gray-400 focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label for="card_number_format" class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1.5">Format eBay</label>
                <select id="card_number_format" class="w-full px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-200 dark:border-dark-500 rounded-lg text-sm text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                    <option value="">Defaut (LOCAL_TOTAL)</option>
                    <option value="LOCAL_ONLY" {% if card.card_number_format and card.card_number_format.value == 'LOCAL_ONLY' %}selected{% endif %}>LOCAL_ONLY</option>
                    <option value="LOCAL_TOTAL" {% if card.card_number_format and card.card_number_format.value == 'LOCAL_TOTAL' %}selected{% endif %}>LOCAL_TOTAL</option>
                    <option value="PROMO" {% if card.card_number_format and card.card_number_format.value == 'PROMO' %}selected{% endif %}>PROMO</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-500 dark:text-gray-400 uppercase mb-1.5">Padding</label>
                <div class="flex items-center gap-3 h-10">
                    <input type="checkbox" id="card_number_padded" {% if card.card_number_padded %}checked{% endif %} class="w-5 h-5 rounded border-gray-300 dark:border-dark-500 text-blue-600 focus:ring-blue-500">
                    <span class="text-sm text-gray-600 dark:text-gray-300">001/092</span>
                </div>
            </div>
        </div>
        <div class="mt-4 flex gap-3">
            <button type="submit" id="save-info-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors">Sauvegarder</button>
            <button type="button" onclick="resetOverrides()" class="px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 border border-gray-300 dark:border-dark-500 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-600">Reset</button>
        </div>
    </form>
</div>

<!-- eBay Query -->
<div class="bg-white dark:bg-dark-700 rounded-xl border border-gray-200 dark:border-dark-500 p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Requete eBay</h2>
    {% if card.ebay_query_override %}
    <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400 mb-2">Override</span>
    <div class="bg-gray-50 dark:bg-dark-600 border border-gray-200 dark:border-dark-500 rounded-lg p-4 font-mono text-sm text-gray-900 dark:text-white break-all mb-4">{{ card.ebay_query_override }}</div>
    <p class="text-sm text-gray-500 dark:text-gray-400 mb-2">Auto-generee:</p>
    {% endif %}
    <div class="bg-gray-50 dark:bg-dark-600 border border-gray-200 dark:border-dark-500 rounded-lg p-4 font-mono text-sm text-gray-900 dark:text-white break-all">{{ card.ebay_query or 'Non generee' }}</div>
</div>

<!-- Photo Modal -->
<div id="photo-modal" onclick="closePhotoModal()" class="hidden fixed inset-0 bg-black/85 z-50 items-center justify-center cursor-pointer">
    <img id="photo-modal-img" src="" alt="" class="max-w-[90%] max-h-[90%] object-contain rounded-lg shadow-2xl">
    <button onclick="closePhotoModal()" class="absolute top-4 right-4 w-10 h-10 flex items-center justify-center bg-white dark:bg-dark-700 rounded-full text-xl">&times;</button>
</div>

<!-- eBay Listings -->
<div class="bg-white dark:bg-dark-700 rounded-xl border border-gray-200 dark:border-dark-500 p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Annonces eBay</h2>
        <button id="refresh-listings" onclick="loadListings(true)" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">Actualiser</button>
    </div>
    <div id="listings-container"><div class="text-center py-12 text-gray-500 dark:text-gray-400">Chargement...</div></div>
</div>

<!-- Sold Listings -->
<div class="bg-white dark:bg-dark-700 rounded-xl border border-gray-200 dark:border-dark-500 p-6 mb-6">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Ventes detectees</h2>
    {% if sold_listings %}
    {% set v_count = sold_stats.count if sold_stats else sold_listings|length %}
    <div class="bg-gray-50 dark:bg-dark-600 rounded-lg p-4 mb-4">
        <div class="flex flex-wrap gap-4 items-center">
            <span class="font-medium text-gray-900 dark:text-white">{{ v_count }} ventes</span>
            {% if sold_stats %}
            {% if sold_stats.p20 %}<span class="text-sm">p20: <strong>{{ "%.2f"|format(sold_stats.p20) }} &euro;</strong></span>{% endif %}
            {% if sold_stats.p50 %}<span class="text-sm">p50: {{ "%.2f"|format(sold_stats.p50) }} &euro;</span>{% endif %}
            {% endif %}
        </div>
    </div>
    <div class="overflow-x-auto max-h-80">
        <table class="w-full min-w-[600px]">
            <thead><tr class="border-b border-gray-200 dark:border-dark-500">
                <th class="w-14 px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Photo</th>
                <th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Titre</th>
                <th class="w-24 px-3 py-2 text-right text-xs font-semibold text-gray-500 uppercase">Prix</th>
                <th class="w-16 px-3 py-2 text-center text-xs font-semibold text-gray-500 uppercase">Duree</th>
                <th class="w-20 px-3 py-2 text-center text-xs font-semibold text-gray-500 uppercase">Date</th>
            </tr></thead>
            <tbody class="divide-y divide-gray-100 dark:divide-dark-500">
            {% for sold in sold_listings %}
            <tr class="hover:bg-gray-50 dark:hover:bg-dark-600">
                <td class="px-3 py-2">{% if sold.image_url %}<img src="{{ sold.image_url }}" onclick="openPhotoModal('{{ sold.image_url }}')" class="w-10 h-10 object-contain rounded bg-gray-100 dark:bg-dark-600 cursor-pointer">{% endif %}</td>
                <td class="px-3 py-2 max-w-[180px]"><div class="truncate text-sm text-gray-900 dark:text-white">{{ sold.title or '-' }}</div></td>
                <td class="px-3 py-2 text-right font-semibold text-green-600 dark:text-green-400 tabular-nums">{{ "%.2f"|format(sold.effective_price or 0) }} &euro;</td>
                <td class="px-3 py-2 text-center text-sm font-mono {% if sold.duration_days is not none and sold.duration_days <= 7 %}text-green-600{% else %}text-gray-500{% endif %}">{% if sold.duration_days is not none %}{{ sold.duration_days }}j{% else %}-{% endif %}</td>
                <td class="px-3 py-2 text-center text-xs text-gray-500 font-mono">{{ sold.detected_sold_at.strftime('%d/%m/%y') }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-8 text-gray-500 dark:text-gray-400">Aucune vente detectee</div>
    {% endif %}
</div>

{% if snapshots %}
<!-- Snapshots History -->
<div class="bg-white dark:bg-dark-700 rounded-xl border border-gray-200 dark:border-dark-500 overflow-hidden">
    <div class="p-6 pb-0"><h2 class="text-lg font-semibold text-gray-900 dark:text-white">Historique</h2></div>
    <div class="overflow-x-auto">
        <table class="w-full min-w-[700px]">
            <thead><tr class="border-b border-gray-200 dark:border-dark-500 bg-gray-50 dark:bg-dark-600">
                <th class="px-4 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Date</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Ann.</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase">p20</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase">p50</th>
                <th class="px-4 py-3 text-right text-xs font-semibold text-gray-500 uppercase">p80</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Disp.</th>
                <th class="px-4 py-3 text-center text-xs font-semibold text-gray-500 uppercase">Cons.</th>
            </tr></thead>
            <tbody class="divide-y divide-gray-100 dark:divide-dark-500">
            {% for snap in snapshots %}
            <tr class="hover:bg-gray-50 dark:hover:bg-dark-600">
                <td class="px-4 py-3 font-mono text-sm text-gray-900 dark:text-white">{{ snap.as_of_date }}</td>
                <td class="px-4 py-3 text-center text-sm text-gray-600 dark:text-gray-400">{{ snap.active_count or '-' }}</td>
                <td class="px-4 py-3 text-right text-sm font-semibold tabular-nums text-gray-900 dark:text-white">{{ "%.2f"|format(snap.p20) if snap.p20 else '-' }}</td>
                <td class="px-4 py-3 text-right text-sm tabular-nums text-gray-900 dark:text-white">{{ "%.2f"|format(snap.p50) if snap.p50 else '-' }}</td>
                <td class="px-4 py-3 text-right text-sm tabular-nums text-gray-900 dark:text-white">{{ "%.2f"|format(snap.p80) if snap.p80 else '-' }}</td>
                <td class="px-4 py-3 text-center text-sm {% if snap.dispersion and snap.dispersion > 4 %}text-red-500{% else %}text-gray-600{% endif %}">{{ "%.2f"|format(snap.dispersion) if snap.dispersion else '-' }}</td>
                <td class="px-4 py-3 text-center text-sm {% if snap.consensus_score and snap.consensus_score >= 70 %}text-green-600{% elif snap.consensus_score and snap.consensus_score < 50 %}text-red-500{% else %}text-gray-600{% endif %}">{{ "%.0f%%"|format(snap.consensus_score) if snap.consensus_score else '-' }}</td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
const cardId = {{ card.id }};
let currentListings = [];

document.getElementById('card-info-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const btn = document.getElementById('save-info-btn');
    btn.disabled = true; btn.textContent = 'Sauvegarde...';
    try {
        const response = await fetch('/api/cards/{{ card.id }}/update-info', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name_override: document.getElementById('name_override').value.trim() || null,
                local_id_override: document.getElementById('local_id_override').value.trim() || null,
                set_name_override: document.getElementById('set_name_override').value.trim() || null,
                card_count_official_override: document.getElementById('card_count_official_override').value.trim() || null,
                card_number_format: document.getElementById('card_number_format').value || null,
                card_number_padded: document.getElementById('card_number_padded').checked,
            })
        });
        const data = await response.json();
        if (data.success) { showToast('Sauvegarde', 'success'); setTimeout(() => location.reload(), 1000); }
        else { showToast('Erreur: ' + (data.error || 'Erreur'), 'error'); }
    } catch (error) { showToast('Erreur: ' + error.message, 'error'); }
    finally { btn.disabled = false; btn.textContent = 'Sauvegarder'; }
});

function resetOverrides() {
    if (confirm('Reinitialiser tous les overrides ?')) {
        ['name_override','local_id_override','set_name_override','card_count_official_override'].forEach(id => document.getElementById(id).value = '');
        document.getElementById('card_number_format').value = '';
        document.getElementById('card_number_padded').checked = false;
        document.getElementById('card-info-form').dispatchEvent(new Event('submit'));
    }
}

function openPhotoModal(url) {
    document.getElementById('photo-modal-img').src = url;
    document.getElementById('photo-modal').classList.remove('hidden');
    document.getElementById('photo-modal').classList.add('flex');
    document.body.style.overflow = 'hidden';
}
function closePhotoModal() {
    document.getElementById('photo-modal').classList.add('hidden');
    document.getElementById('photo-modal').classList.remove('flex');
    document.body.style.overflow = '';
}
document.addEventListener('keydown', e => { if (e.key === 'Escape') closePhotoModal(); });

function renderListings() {
    const container = document.getElementById('listings-container');
    if (currentListings.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500">Aucune annonce. Cliquez Actualiser.</div>';
        return;
    }
    let html = '<div class="overflow-x-auto max-h-80"><table class="w-full min-w-[500px]"><thead><tr class="border-b border-gray-200 dark:border-dark-500"><th class="w-14 px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Photo</th><th class="w-24 px-3 py-2 text-right text-xs font-semibold text-gray-500 uppercase">Prix</th><th class="px-3 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Titre</th><th class="w-16 px-3 py-2"></th></tr></thead><tbody class="divide-y divide-gray-100 dark:divide-dark-500">';
    for (const l of currentListings) {
        html += `<tr class="hover:bg-gray-50 dark:hover:bg-dark-600">
            <td class="px-3 py-2">${l.image ? `<img src="${l.image}" onclick="openPhotoModal('${l.image}')" class="w-10 h-10 object-contain rounded bg-gray-100 dark:bg-dark-600 cursor-pointer">` : ''}</td>
            <td class="px-3 py-2 text-right"><div class="font-semibold text-gray-900 dark:text-white tabular-nums">${(l.price||0).toFixed(2)} &euro;</div>${l.shipping > 0 ? `<div class="text-xs text-gray-500">+${l.shipping.toFixed(2)}</div>` : ''}</td>
            <td class="px-3 py-2 max-w-[180px]"><div class="truncate text-sm text-gray-900 dark:text-white">${l.title || '-'}</div></td>
            <td class="px-3 py-2">${l.url ? `<a href="${l.url}" target="_blank" class="text-xs text-blue-600">Voir</a>` : ''}</td>
        </tr>`;
    }
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

async function loadListings(refresh = false) {
    const container = document.getElementById('listings-container');
    const btn = document.getElementById('refresh-listings');
    if (refresh) { btn.disabled = true; btn.textContent = 'Chargement...'; }
    container.innerHTML = '<div class="text-center py-12 text-gray-500">Chargement...</div>';
    try {
        const response = await fetch(`/api/cards/${cardId}/listings` + (refresh ? '?refresh=true' : ''));
        const data = await response.json();
        if (!data.success) { container.innerHTML = `<div class="text-center py-12 text-red-500">${data.error || 'Erreur'}</div>`; return; }
        currentListings = (data.listings || []).sort((a, b) => (a.effective_price || a.price || 0) - (b.effective_price || b.price || 0));
        renderListings();
    } catch (error) { container.innerHTML = `<div class="text-center py-12 text-red-500">Erreur: ${error.message}</div>`; }
    finally { btn.disabled = false; btn.textContent = 'Actualiser'; }
}

document.addEventListener('DOMContentLoaded', () => loadListings(false));
</script>
{% endblock %}
