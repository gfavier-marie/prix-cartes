{% extends "base.html" %}

{% block title %}Series{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-6 flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4">
    <div>
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 dark:text-white">Series</h1>
        <p class="mt-1 text-gray-500 dark:text-gray-400">Selectionnez une ou plusieurs series pour lancer la collecte, ou cliquez sur un nom pour voir les cartes</p>
    </div>
    <div class="flex items-center gap-2">
        <button id="toggle-all-btn" onclick="toggleAllSeries()" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 border border-gray-300 dark:border-dark-500 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-600">
            <svg id="toggle-all-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/></svg>
            <span id="toggle-all-text">Tout afficher</span>
        </button>
        <button id="refresh-stats-btn" onclick="refreshStats()" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 border border-gray-300 dark:border-dark-500 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-600">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
            Actualiser
        </button>
    </div>
</div>

<!-- Auto-launch -->
<div class="bg-white dark:bg-dark-700 rounded-xl border border-gray-200 dark:border-dark-500 p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h3 class="font-semibold text-gray-900 dark:text-white">Lancement automatique</h3>
            <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Lance les sets jamais traites ou les plus anciens</p>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
            <select id="auto-limit" class="px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-200 dark:border-dark-500 rounded-lg text-sm text-gray-900 dark:text-white">
                <option value="5">5 sets</option>
                <option value="10" selected>10 sets</option>
                <option value="20">20 sets</option>
                <option value="50">50 sets</option>
            </select>
            <select id="auto-workers" class="px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-200 dark:border-dark-500 rounded-lg text-sm text-gray-900 dark:text-white">
                <option value="1">1 worker</option>
                <option value="2">2 workers</option>
                <option value="3" selected>3 workers</option>
                <option value="5">5 workers</option>
            </select>
            <button id="auto-launch-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                Lancer auto
            </button>
        </div>
    </div>
</div>

<!-- Queue Status -->
<div id="queue-status" class="hidden bg-white dark:bg-dark-700 rounded-xl border border-gray-200 dark:border-dark-500 p-4 sm:p-6 mb-6">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Queue de batchs</h2>
        <div class="flex items-center gap-3">
            <span id="status-badge" class="inline-flex px-2.5 py-0.5 text-xs font-medium rounded-full bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400">En cours...</span>
            <button id="stop-batch-btn" class="inline-flex items-center gap-2 px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white text-xs font-medium rounded-lg transition-colors">Tout arreter</button>
        </div>
    </div>
    <div id="queue-content" class="text-gray-500 dark:text-gray-400">Chargement...</div>
</div>

<!-- Selection Bar (sticky) -->
<div id="selection-bar" class="hidden sticky top-16 z-40 bg-white dark:bg-dark-700 rounded-xl border border-gray-200 dark:border-dark-500 p-4 mb-6 shadow-lg">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div class="flex items-center gap-4 flex-wrap">
            <span class="font-medium text-gray-900 dark:text-white"><span id="selection-count">0</span> set(s)</span>
            <span id="estimate-info" class="text-sm text-gray-500 dark:text-gray-400"></span>
        </div>
        <div class="flex items-center gap-2">
            <select id="selection-workers" class="px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-200 dark:border-dark-500 rounded-lg text-sm text-gray-900 dark:text-white">
                <option value="1">1 worker</option>
                <option value="2">2 workers</option>
                <option value="3" selected>3 workers</option>
                <option value="5">5 workers</option>
            </select>
            <button id="clear-selection-btn" class="px-3 py-2 text-sm font-medium text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white">Effacer</button>
            <button id="export-csv-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                Exporter CSV
            </button>
            <button id="launch-queue-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors">Lancer</button>
        </div>
    </div>
</div>

<!-- Series List -->
{% for serie in series_sets %}
<div class="bg-white dark:bg-dark-700 rounded-xl border border-gray-200 dark:border-dark-500 mb-4 overflow-hidden">
    <div class="p-4 flex items-center justify-between cursor-pointer hover:bg-gray-50 dark:hover:bg-dark-600 transition-colors" onclick="toggleSerie('{{ serie.serie_id }}')">
        <div class="flex items-center gap-3">
            <span id="icon-{{ serie.serie_id }}" class="w-6 h-6 flex items-center justify-center bg-gray-100 dark:bg-dark-500 rounded text-sm font-bold text-gray-500 dark:text-gray-400">+</span>
            <h3 class="font-semibold text-gray-900 dark:text-white">{{ serie.serie_name }}</h3>
            <span class="inline-flex px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 dark:bg-dark-500 text-gray-600 dark:text-gray-300">{{ serie.sets|length }} sets</span>
        </div>
        <button class="px-3 py-1.5 text-xs font-medium text-gray-500 dark:text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 transition-colors" onclick="event.stopPropagation(); selectAllSerie('{{ serie.serie_id }}')">Tout selectionner</button>
    </div>
    <div id="sets-{{ serie.serie_id }}" class="hidden border-t border-gray-200 dark:border-dark-500">
        <div class="overflow-x-auto">
            <table class="w-full min-w-[500px]">
                <thead><tr class="bg-gray-50 dark:bg-dark-600">
                    <th class="w-10 px-4 py-2"></th>
                    <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Set</th>
                    <th class="px-4 py-2 text-center text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Dernier maj</th>
                    <th class="px-4 py-2 text-right text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase">Progression</th>
                </tr></thead>
                <tbody class="divide-y divide-gray-100 dark:divide-dark-500">
                {% for set in serie.sets %}
                <tr class="hover:bg-gray-50 dark:hover:bg-dark-600">
                    <td class="px-4 py-3"><input type="checkbox" class="set-checkbox w-4 h-4 rounded border-gray-300 dark:border-dark-500 text-blue-600 focus:ring-blue-500" data-set-id="{{ set.id }}" data-set-name="{{ set.name }}" data-serie="{{ serie.serie_id }}"></td>
                    <td class="px-4 py-3">
                        <a href="{{ url_for('cards_list', set=set.id) }}" class="font-medium text-gray-900 dark:text-white hover:text-blue-600 dark:hover:text-blue-400 transition-colors">{{ set.name }}</a>
                        <div class="text-xs text-gray-500 dark:text-gray-400 font-mono">{{ set.id }}</div>
                    </td>
                    <td class="px-4 py-3 text-center text-sm text-gray-500 dark:text-gray-400 set-last-snapshot" data-set-id="{{ set.id }}">{{ set.last_snapshot.strftime('%d/%m/%y') if set.last_snapshot else '-' }}</td>
                    <td class="px-4 py-3 text-right set-progress" data-set-id="{{ set.id }}">
                        {% if set.card_count > 0 %}
                        {% set pct = (set.price_count / set.card_count * 100)|round(0)|int %}
                        {% set error_pct = (set.error_count / set.card_count * 100)|round(0)|int if set.error_count else 0 %}
                        <div class="flex items-center justify-end gap-2">
                            <span class="text-xs font-mono text-gray-600 dark:text-gray-400">{{ set.price_count }}/{{ set.card_count }}</span>
                            <div class="w-16 h-1.5 bg-gray-200 dark:bg-dark-500 rounded-full overflow-hidden">
                                <div class="h-full rounded-full {% if pct == 100 %}bg-green-500{% else %}bg-blue-500{% endif %}" style="width: {{ pct }}%"></div>
                            </div>
                            <span class="text-xs font-mono w-8 text-right {% if pct == 100 %}text-green-600 dark:text-green-400{% else %}text-gray-600 dark:text-gray-400{% endif %}">{{ pct }}%</span>
                        </div>
                        {% if set.error_count > 0 %}
                        <div class="text-[10px] text-red-500 mt-0.5">{{ set.error_count }} err</div>
                        {% endif %}
                        {% else %}-{% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
const selectedSets = new Set();
let estimateTimeout = null;
let statusInterval = null;
let hasStartedProcessing = false;
let allExpanded = false;

function toggleAllSeries() {
    const allContainers = document.querySelectorAll('[id^="sets-"]');
    const allIcons = document.querySelectorAll('[id^="icon-"]');

    allExpanded = !allExpanded;

    allContainers.forEach(container => {
        container.classList.toggle('hidden', !allExpanded);
    });

    allIcons.forEach(icon => {
        icon.textContent = allExpanded ? '-' : '+';
    });

    document.getElementById('toggle-all-text').textContent = allExpanded ? 'Tout fermer' : 'Tout afficher';
}

function toggleSerie(serieId) {
    const container = document.getElementById('sets-' + serieId);
    const icon = document.getElementById('icon-' + serieId);
    const isHidden = container.classList.contains('hidden');
    container.classList.toggle('hidden');
    icon.textContent = isHidden ? '-' : '+';
}

function selectAllSerie(serieId) {
    const checkboxes = document.querySelectorAll(`.set-checkbox[data-serie="${serieId}"]`);
    const allChecked = Array.from(checkboxes).every(cb => cb.checked);
    checkboxes.forEach(cb => { cb.checked = !allChecked; updateSelection(cb); });
}

function updateSelection(checkbox) {
    const setId = checkbox.dataset.setId;
    const setName = checkbox.dataset.setName;
    const key = JSON.stringify({set_id: setId, set_name: setName});
    checkbox.checked ? selectedSets.add(key) : selectedSets.delete(key);
    updateSelectionBar();
}

function updateSelectionBar() {
    const bar = document.getElementById('selection-bar');
    document.getElementById('selection-count').textContent = selectedSets.size;
    bar.classList.toggle('hidden', selectedSets.size === 0);
    if (estimateTimeout) clearTimeout(estimateTimeout);
    if (selectedSets.size > 0) { estimateTimeout = setTimeout(updateEstimate, 300); }
    else { document.getElementById('estimate-info').textContent = ''; }
}

async function updateEstimate() {
    const setIds = Array.from(selectedSets).map(s => JSON.parse(s).set_id);
    if (setIds.length === 0) return;
    try {
        const response = await fetch('/api/batch/estimate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ set_ids: setIds }) });
        const data = await response.json();
        const color = data.will_exceed ? 'text-red-500' : '';
        document.getElementById('estimate-info').innerHTML = `~<strong>${data.total_cards}</strong> cartes / <strong class="${color}">${data.estimated_calls}</strong> API (reste: ${data.remaining})${data.will_exceed ? ' <span class="text-red-500">Depassera!</span>' : ''}`;
    } catch (e) { console.error(e); }
}

document.querySelectorAll('.set-checkbox').forEach(cb => cb.addEventListener('change', function() { updateSelection(this); }));
document.getElementById('clear-selection-btn').addEventListener('click', function() { selectedSets.clear(); document.querySelectorAll('.set-checkbox').forEach(cb => cb.checked = false); updateSelectionBar(); });

document.getElementById('export-csv-btn').addEventListener('click', function() {
    if (selectedSets.size === 0) return;
    const setIds = Array.from(selectedSets).map(s => JSON.parse(s).set_id);
    const params = setIds.map(id => 'sets=' + encodeURIComponent(id)).join('&');
    window.location.href = '/export/csv?' + params;
});

document.getElementById('launch-queue-btn').addEventListener('click', async function() {
    if (selectedSets.size === 0) return;
    const sets = Array.from(selectedSets).map(s => JSON.parse(s));
    const maxWorkers = parseInt(document.getElementById('selection-workers').value);
    this.disabled = true; this.textContent = 'Ajout...';
    try {
        const response = await fetch('/api/batch/run', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sets, max_workers: maxWorkers }) });
        if (response.ok) { selectedSets.clear(); document.querySelectorAll('.set-checkbox').forEach(cb => cb.checked = false); updateSelectionBar(); showQueueStatus(); startStatusPolling(); }
        else { const data = await response.json(); showToast('Erreur: ' + (data.error || 'Erreur'), 'error'); }
    } catch (error) { showToast('Erreur: ' + error.message, 'error'); }
    finally { this.disabled = false; this.textContent = 'Lancer'; }
});

function showQueueStatus() { document.getElementById('queue-status').classList.remove('hidden'); }
function hideQueueStatus() { document.getElementById('queue-status').classList.add('hidden'); }

function startStatusPolling() {
    if (statusInterval) clearInterval(statusInterval);
    updateQueueStatus();
    statusInterval = setInterval(updateQueueStatus, 2000);
}

async function updateQueueStatus() {
    try {
        const response = await fetch('/api/batch/status');
        const data = await response.json();
        const content = document.getElementById('queue-content');
        const badge = document.getElementById('status-badge');
        const stopBtn = document.getElementById('stop-batch-btn');

        if (data.running || data.pending_count > 0) {
            hasStartedProcessing = true;
            showQueueStatus();
            let html = '';
            if (data.running_items && data.running_items.length > 0) {
                html += '<p class="text-sm text-gray-500 dark:text-gray-400 mb-2">En cours:</p>';
                data.running_items.forEach(c => {
                    const pct = c.cards_targeted > 0 ? Math.round((c.cards_succeeded + c.cards_failed) / c.cards_targeted * 100) : 0;
                    html += `<div class="p-3 mb-2 rounded-lg bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 flex items-center justify-between">
                        <div><strong class="text-gray-900 dark:text-white">${c.set_name}</strong> <span class="text-sm text-gray-500">(${c.set_id})</span></div>
                        <div class="flex items-center gap-3"><span class="text-sm">${c.cards_succeeded}/${c.cards_targeted}</span>
                        <div class="w-20 h-1.5 bg-gray-200 dark:bg-dark-500 rounded-full overflow-hidden"><div class="h-full bg-blue-500 rounded-full" style="width:${pct}%"></div></div></div></div>`;
                });
                badge.textContent = 'En cours (' + data.running_count + '/' + data.max_workers + ')';
                badge.className = 'inline-flex px-2.5 py-0.5 text-xs font-medium rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400';
            }
            if (data.pending && data.pending.length > 0) {
                html += '<p class="text-sm text-gray-500 dark:text-gray-400 mt-4 mb-2">En attente (' + data.pending_count + '):</p>';
                data.pending.slice(0, 5).forEach(p => { html += `<div class="p-2 mb-1 rounded bg-gray-50 dark:bg-dark-600 text-sm"><strong>${p.set_name}</strong></div>`; });
                if (data.pending_count > 5) html += `<p class="text-sm text-gray-400">... et ${data.pending_count - 5} autres</p>`;
            }
            content.innerHTML = html || '<p class="text-gray-500">Queue vide</p>';
            stopBtn.style.display = 'inline-flex';
        } else if (hasStartedProcessing) {
            clearInterval(statusInterval); statusInterval = null;
            badge.textContent = 'Termine'; badge.className = 'inline-flex px-2.5 py-0.5 text-xs font-medium rounded-full bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400';
            stopBtn.style.display = 'none';
            content.innerHTML = '<p class="text-green-600 dark:text-green-400">Queue terminee!</p>';
            setTimeout(() => window.location.reload(), 3000);
        } else { clearInterval(statusInterval); statusInterval = null; hideQueueStatus(); }
    } catch (error) { console.error(error); }
}

document.getElementById('stop-batch-btn').addEventListener('click', async function() {
    if (!confirm('Arreter toute la queue ?')) return;
    this.disabled = true; this.textContent = 'Arret...';
    try { await fetch('/api/batch/stop', { method: 'POST' }); this.textContent = 'Arret demande'; } catch (e) { showToast('Erreur', 'error'); this.disabled = false; this.textContent = 'Tout arreter'; }
});

fetch('/api/batch/status').then(r => r.json()).then(data => { if (data.running || data.pending_count > 0) { hasStartedProcessing = true; showQueueStatus(); startStatusPolling(); } });

async function refreshStats() {
    const btn = document.getElementById('refresh-stats-btn');
    btn.disabled = true; btn.innerHTML = '<svg class="w-4 h-4 spinner" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>';
    try {
        const response = await fetch('/api/batch/set-stats');
        const stats = await response.json();
        document.querySelectorAll('.set-progress').forEach(cell => {
            const data = stats[cell.dataset.setId];
            if (data && data.card_count > 0) {
                const barClass = data.pct === 100 ? 'bg-green-500' : 'bg-blue-500';
                const textClass = data.pct === 100 ? 'text-green-600 dark:text-green-400' : 'text-gray-600 dark:text-gray-400';
                cell.innerHTML = `<div class="flex items-center justify-end gap-2"><span class="text-xs font-mono text-gray-600 dark:text-gray-400">${data.price_count}/${data.card_count}</span><div class="w-16 h-1.5 bg-gray-200 dark:bg-dark-500 rounded-full overflow-hidden"><div class="h-full rounded-full ${barClass}" style="width:${data.pct}%"></div></div><span class="text-xs font-mono w-8 text-right ${textClass}">${data.pct}%</span></div>${data.error_count > 0 ? `<div class="text-[10px] text-red-500 mt-0.5">${data.error_count} err</div>` : ''}`;
            }
        });
        document.querySelectorAll('.set-last-snapshot').forEach(cell => { const data = stats[cell.dataset.setId]; cell.textContent = data?.last_snapshot || '-'; });
        showToast('Stats actualisees', 'success');
    } catch (e) { showToast('Erreur', 'error'); }
    finally { btn.disabled = false; btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg> Actualiser'; }
}

document.getElementById('auto-launch-btn').addEventListener('click', async function() {
    const limit = document.getElementById('auto-limit').value;
    const maxWorkers = parseInt(document.getElementById('auto-workers').value);
    this.disabled = true; this.textContent = 'Chargement...';
    try {
        const priorityResponse = await fetch(`/api/batch/priority-sets?limit=${limit}`);
        const priorityData = await priorityResponse.json();
        if (!priorityData.sets || priorityData.sets.length === 0) { showToast('Aucun set a lancer', 'warning'); return; }
        const sets = priorityData.sets.map(s => ({ set_id: s.set_id, set_name: s.set_name }));
        const response = await fetch('/api/batch/run', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ sets, max_workers: maxWorkers }) });
        if (response.ok) { showQueueStatus(); startStatusPolling(); } else { const data = await response.json(); showToast('Erreur: ' + (data.error || 'Erreur'), 'error'); }
    } catch (error) { showToast('Erreur: ' + error.message, 'error'); }
    finally { this.disabled = false; this.textContent = 'Lancer auto'; }
});
</script>
{% endblock %}
