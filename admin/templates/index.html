{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Dashboard</h1>
    <p>Vue d'ensemble de vos prix de rachat Pokemon</p>
</div>

<div class="stats-grid">
    <div class="stat-box accent-blue">
        <div class="stat-value">{{ "{:,}".format(total_cards).replace(",", " ") }}</div>
        <div class="stat-label">Cartes actives</div>
    </div>
    <div class="stat-box accent-green">
        <div class="stat-value">{{ "{:,}".format(cards_with_price).replace(",", " ") }}</div>
        <div class="stat-label">Avec prix calculé</div>
    </div>
    <div class="stat-box accent-yellow">
        <div class="stat-value">{{ low_conf }}</div>
        <div class="stat-label">Confiance faible</div>
    </div>
</div>

{% if api_usage %}
<div class="card">
    <div class="card-header">
        <h2>Usage API eBay</h2>
        {% if api_usage.is_limit_reached %}
        <span class="badge badge-error">Limite atteinte</span>
        {% elif api_usage.percent > 80 %}
        <span class="badge badge-warning">{{ api_usage.percent }}%</span>
        {% else %}
        <span class="badge badge-ok">{{ api_usage.percent }}%</span>
        {% endif %}
    </div>
    <div class="progress-bar-container" style="background: #333; border-radius: 4px; height: 24px; margin: 12px 0; position: relative; overflow: hidden;">
        <div class="progress-bar-fill" style="background: {% if api_usage.percent > 80 %}#ef4444{% elif api_usage.percent > 50 %}#f59e0b{% else %}#22c55e{% endif %}; height: 100%; width: {{ api_usage.percent }}%; transition: width 0.3s;"></div>
        <span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: white; font-size: 12px; font-weight: 500;">
            {{ "{:,}".format(api_usage.today_count).replace(",", " ") }} / {{ "{:,}".format(api_usage.daily_limit).replace(",", " ") }} appels
        </span>
    </div>
    <div style="display: flex; justify-content: space-between; color: #888; font-size: 13px;">
        <span>Restants: {{ "{:,}".format(api_usage.remaining).replace(",", " ") }}</span>
        <span>Limite quotidienne: {{ "{:,}".format(api_usage.daily_limit).replace(",", " ") }}</span>
    </div>
    {% if api_usage.history|length > 1 %}
    <details style="margin-top: 12px;">
        <summary style="cursor: pointer; color: #888; font-size: 13px;">Historique (7 derniers jours)</summary>
        <table class="info-table" style="margin-top: 8px;">
            {% for h in api_usage.history %}
            <tr>
                <td>{{ h.date }}</td>
                <td>{{ "{:,}".format(h.count).replace(",", " ") }} appels</td>
                <td>{{ h.percent }}%</td>
            </tr>
            {% endfor %}
        </table>
    </details>
    {% endif %}
</div>
{% endif %}

{% if last_batch %}
<div class="card">
    <div class="card-header">
        <h2>Dernier batch</h2>
        <span class="badge badge-ok">{{ last_batch.mode.value }}</span>
    </div>
    <table class="info-table">
        <tr>
            <td>Date</td>
            <td>{{ last_batch.started_at.strftime('%d/%m/%Y à %H:%M') }}</td>
        </tr>
        <tr>
            <td>Cartes traitées</td>
            <td>{{ last_batch.cards_succeeded }} / {{ last_batch.cards_targeted }}</td>
        </tr>
        <tr>
            <td>Échecs</td>
            <td>{{ last_batch.cards_failed }}</td>
        </tr>
        {% if last_batch.finished_at %}
        <tr>
            <td>Durée</td>
            <td>{{ ((last_batch.finished_at - last_batch.started_at).total_seconds() / 60)|round(1) }} minutes</td>
        </tr>
        {% endif %}
    </table>
</div>
{% endif %}

<div class="card">
    <h2>Actions rapides</h2>
    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <a href="{{ url_for('cards_list') }}" class="btn btn-primary">Voir les cartes</a>
        <a href="{{ url_for('anomalies') }}" class="btn btn-warning">Voir les anomalies</a>
        <a href="{{ url_for('batches') }}" class="btn btn-ghost">Historique batches</a>
        <a href="{{ url_for('export_csv') }}" class="btn btn-ok" style="background: #22c55e; color: white;">Exporter CSV</a>
    </div>
</div>
{% endblock %}
