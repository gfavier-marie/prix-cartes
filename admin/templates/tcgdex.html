{% extends "base.html" %}
{% block title %}TCGdex Sync{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Synchronisation TCGdex</h1>
    <p class="text-gray-500 dark:text-gray-400 mt-1">Détecter et importer les nouvelles séries depuis l'API TCGdex</p>
</div>

<!-- Gestion des séries et sets -->
<div class="bg-white dark:bg-dark-700 rounded-lg shadow-sm mb-6 overflow-hidden">
    <div class="p-4 border-b border-gray-200 dark:border-dark-600 flex flex-wrap items-center justify-between gap-4">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Gestion de la visibilité</h2>
        <div class="flex gap-2">
            <button class="tab-btn px-4 py-2 text-sm font-medium rounded-lg transition-colors bg-blue-600 text-white" id="tab-series" onclick="switchTab('series')">
                Par Série
            </button>
            <button class="tab-btn px-4 py-2 text-sm font-medium rounded-lg transition-colors bg-gray-100 dark:bg-dark-600 text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-dark-500" id="tab-sets" onclick="switchTab('sets')">
                Par Set
            </button>
        </div>
    </div>

    <div id="visibility-loading" class="hidden p-8 text-center">
        <div class="inline-block w-10 h-10 border-3 border-gray-200 dark:border-dark-600 border-t-blue-500 rounded-full animate-spin"></div>
        <p class="mt-3 text-gray-500 dark:text-gray-400">Chargement...</p>
    </div>

    <!-- Vue par Séries -->
    <div id="series-view" class="hidden">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 p-4">
            <div class="bg-gray-50 dark:bg-dark-600 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-gray-900 dark:text-white" id="total-series">-</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Séries totales</div>
            </div>
            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="visible-series">-</div>
                <div class="text-sm text-green-600 dark:text-green-400">Séries visibles</div>
            </div>
            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="hidden-series">-</div>
                <div class="text-sm text-red-600 dark:text-red-400">Séries masquées</div>
            </div>
        </div>

        <div class="overflow-x-auto">
            <table class="w-full min-w-[700px]">
                <thead class="bg-gray-50 dark:bg-dark-600">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Série ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Nom</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Sets</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Cartes</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Date début</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Visible</th>
                    </tr>
                </thead>
                <tbody id="series-tbody" class="divide-y divide-gray-200 dark:divide-dark-600"></tbody>
            </table>
        </div>
    </div>

    <!-- Vue par Sets -->
    <div id="sets-view" class="hidden">
        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 p-4">
            <div class="bg-gray-50 dark:bg-dark-600 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-gray-900 dark:text-white" id="total-sets">-</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Sets totaux</div>
            </div>
            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="visible-sets">-</div>
                <div class="text-sm text-green-600 dark:text-green-400">Sets visibles</div>
            </div>
            <div class="bg-red-50 dark:bg-red-900/20 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="hidden-sets">-</div>
                <div class="text-sm text-red-600 dark:text-red-400">Sets masqués</div>
            </div>
        </div>

        <div class="px-4 pb-4">
            <input type="text" id="sets-filter" placeholder="Filtrer par nom ou série..."
                   onkeyup="filterSets()"
                   class="w-full max-w-xs px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-300 dark:border-dark-500 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="overflow-x-auto">
            <table class="w-full min-w-[700px]">
                <thead class="bg-gray-50 dark:bg-dark-600">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Set ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Nom</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Série</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Cartes</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Date</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Visible</th>
                    </tr>
                </thead>
                <tbody id="visibility-sets-tbody" class="divide-y divide-gray-200 dark:divide-dark-600"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Scanner nouveaux sets -->
<div class="bg-white dark:bg-dark-700 rounded-lg shadow-sm overflow-hidden">
    <div class="p-4 border-b border-gray-200 dark:border-dark-600 flex flex-wrap items-center justify-between gap-4">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Scanner les nouveaux sets</h2>
        <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors" id="check-btn" onclick="checkNewSets()">
            Vérifier les nouveaux sets
        </button>
    </div>

    <div id="scan-result" class="hidden">
        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 p-4">
            <div class="bg-gray-50 dark:bg-dark-600 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-gray-900 dark:text-white" id="total-tcgdex">-</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Sets sur TCGdex</div>
            </div>
            <div class="bg-gray-50 dark:bg-dark-600 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-gray-900 dark:text-white" id="existing-sets">-</div>
                <div class="text-sm text-gray-500 dark:text-gray-400">Sets en base</div>
            </div>
            <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-blue-600 dark:text-blue-400" id="imported-sets">-</div>
                <div class="text-sm text-blue-600 dark:text-blue-400">Sets importés</div>
            </div>
            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="new-sets-count">-</div>
                <div class="text-sm text-green-600 dark:text-green-400">Nouveaux sets</div>
            </div>
        </div>

        <div id="new-sets-list" class="hidden">
            <div class="px-4 pb-4 flex flex-wrap items-center justify-between gap-4">
                <h3 class="text-base font-medium text-gray-900 dark:text-white">Nouveaux sets détectés</h3>
                <div class="flex gap-2">
                    <button class="px-3 py-1.5 text-sm border border-gray-300 dark:border-dark-500 text-gray-700 dark:text-gray-300 rounded-lg hover:bg-gray-50 dark:hover:bg-dark-600 transition-colors" onclick="toggleSelectAll()">
                        <span id="select-all-text">Tout sélectionner</span>
                    </button>
                    <button class="px-4 py-1.5 text-sm bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors disabled:opacity-50" id="import-btn" onclick="importSelected()" disabled>
                        Importer les sets sélectionnés
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full min-w-[600px]">
                    <thead class="bg-gray-50 dark:bg-dark-600">
                        <tr>
                            <th class="px-4 py-3 w-10"></th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Set ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Nom</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Cartes</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Date de sortie</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody id="sets-tbody" class="divide-y divide-gray-200 dark:divide-dark-600"></tbody>
                </table>
            </div>
        </div>

        <div id="no-new-sets" class="hidden p-8 text-center text-gray-500 dark:text-gray-400">
            <svg class="w-12 h-12 mx-auto mb-3 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p>Aucun nouveau set détecté. La base de données est à jour.</p>
        </div>
    </div>

    <div id="loading" class="hidden p-8 text-center">
        <div class="inline-block w-10 h-10 border-3 border-gray-200 dark:border-dark-600 border-t-blue-500 rounded-full animate-spin"></div>
        <p id="loading-text" class="mt-3 text-gray-500 dark:text-gray-400">Analyse en cours...</p>
    </div>
</div>

<!-- Export des annonces -->
<div class="bg-white dark:bg-dark-700 rounded-lg shadow-sm mt-6 overflow-hidden">
    <div class="p-4 border-b border-gray-200 dark:border-dark-600">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Export des annonces eBay</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Exporter les annonces du dernier snapshot par série/set avec filtres de prix</p>
    </div>

    <div class="p-4 space-y-4">
        <!-- Sélection série -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Série</label>
            <select id="export-series" onchange="onSeriesChange()"
                    class="w-full max-w-xs px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-300 dark:border-dark-500 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                <option value="">Toutes les séries</option>
            </select>
        </div>

        <!-- Sélection sets (multi-select) -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sets (optionnel)</label>
            <div id="export-sets-container" class="flex flex-wrap gap-2 max-h-32 overflow-y-auto p-2 bg-gray-50 dark:bg-dark-600 rounded-lg border border-gray-300 dark:border-dark-500">
                <span class="text-sm text-gray-500 dark:text-gray-400">Sélectionnez une série pour voir les sets</span>
            </div>
        </div>

        <!-- Filtres prix -->
        <div class="flex flex-wrap gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prix min (€)</label>
                <input type="number" id="export-price-min" min="0" step="0.01" placeholder="0"
                       class="w-28 px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-300 dark:border-dark-500 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Prix max (€)</label>
                <input type="number" id="export-price-max" min="0" step="0.01" placeholder="∞"
                       class="w-28 px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-300 dark:border-dark-500 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <!-- Types de listings -->
        <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Types d'annonces</label>
            <div class="flex flex-wrap gap-4">
                <label class="inline-flex items-center">
                    <input type="checkbox" id="export-type-normal" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Normal</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" id="export-type-reverse" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Reverse</span>
                </label>
                <label class="inline-flex items-center">
                    <input type="checkbox" id="export-type-graded" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Graded (PSA/CGC)</span>
                </label>
            </div>
        </div>

        <!-- Bouton export -->
        <div class="pt-2">
            <button onclick="exportListings()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition-colors">
                Exporter CSV
            </button>
        </div>
    </div>
</div>

<!-- Résultats d'import -->
<div id="import-results" class="hidden bg-white dark:bg-dark-700 rounded-lg shadow-sm mt-6 overflow-hidden">
    <div class="p-4 border-b border-gray-200 dark:border-dark-600">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Résultats de l'import</h2>
    </div>
    <div id="import-results-content" class="p-4"></div>
</div>

<style>
    /* Toggle switch */
    .toggle-switch {
        position: relative;
        display: inline-block;
        width: 48px;
        height: 26px;
    }
    .toggle-switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }
    .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #d1d5db;
        transition: 0.3s;
        border-radius: 26px;
    }
    .dark .toggle-slider {
        background-color: #4b5563;
    }
    .toggle-slider:before {
        position: absolute;
        content: "";
        height: 20px;
        width: 20px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: 0.3s;
        border-radius: 50%;
    }
    .toggle-switch input:checked + .toggle-slider {
        background-color: #22c55e;
    }
    .toggle-switch input:checked + .toggle-slider:before {
        transform: translateX(22px);
    }
    .toggle-switch.loading .toggle-slider {
        opacity: 0.6;
        pointer-events: none;
    }
    /* Spinner */
    .border-3 {
        border-width: 3px;
    }
</style>

<script>
    let newSets = [];
    let allSelected = false;
    let seriesData = [];
    let setsData = [];
    let currentTab = 'series';
    let dataLoaded = { series: false, sets: false };
    let exportSeriesData = [];  // Pour l'export

    function switchTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-blue-600', 'text-white');
            btn.classList.add('bg-gray-100', 'dark:bg-dark-600', 'text-gray-600', 'dark:text-gray-400');
        });
        const activeBtn = document.getElementById(`tab-${tab}`);
        activeBtn.classList.remove('bg-gray-100', 'dark:bg-dark-600', 'text-gray-600', 'dark:text-gray-400');
        activeBtn.classList.add('bg-blue-600', 'text-white');

        document.getElementById('series-view').classList.toggle('hidden', tab !== 'series');
        document.getElementById('sets-view').classList.toggle('hidden', tab !== 'sets');

        if (tab === 'series' && !dataLoaded.series) loadSeries();
        else if (tab === 'sets' && !dataLoaded.sets) loadSets();
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadSeries();
    });

    function loadSeries() {
        const loading = document.getElementById('visibility-loading');
        const seriesView = document.getElementById('series-view');
        loading.classList.remove('hidden');
        seriesView.classList.add('hidden');

        fetch('/api/tcgdex/series')
            .then(r => r.json())
            .then(data => {
                loading.classList.add('hidden');
                if (!data.success) { showToast('Erreur: ' + data.error, 'error'); return; }

                seriesData = data.series;
                dataLoaded.series = true;
                const visible = seriesData.filter(s => s.is_visible).length;
                document.getElementById('total-series').textContent = seriesData.length;
                document.getElementById('visible-series').textContent = visible;
                document.getElementById('hidden-series').textContent = seriesData.length - visible;
                renderSeriesList();
                seriesView.classList.remove('hidden');
            })
            .catch(err => { loading.classList.add('hidden'); showToast('Erreur: ' + err.message, 'error'); });
    }

    function renderSeriesList() {
        const tbody = document.getElementById('series-tbody');
        tbody.innerHTML = '';
        seriesData.forEach(serie => {
            const tr = document.createElement('tr');
            tr.className = `hover:bg-gray-50 dark:hover:bg-dark-600/50 ${serie.is_visible ? '' : 'opacity-60'}`;
            tr.id = `serie-row-${serie.serie_id}`;
            tr.innerHTML = `
                <td class="px-4 py-3 font-mono text-sm text-gray-900 dark:text-white">${serie.serie_id}</td>
                <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">${serie.serie_name}</td>
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300 text-right">${serie.set_count}</td>
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300 text-right">${serie.card_count}</td>
                <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${serie.first_date || '-'}</td>
                <td class="px-4 py-3 text-center">
                    <label class="toggle-switch" id="toggle-${serie.serie_id}">
                        <input type="checkbox" ${serie.is_visible ? 'checked' : ''} onchange="toggleSerie('${serie.serie_id}')">
                        <span class="toggle-slider"></span>
                    </label>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function toggleSerie(serieId) {
        const toggle = document.getElementById(`toggle-${serieId}`);
        const row = document.getElementById(`serie-row-${serieId}`);
        const checkbox = toggle.querySelector('input');
        toggle.classList.add('loading');

        fetch(`/api/tcgdex/series/${serieId}/toggle`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                toggle.classList.remove('loading');
                if (!data.success) { checkbox.checked = !checkbox.checked; showToast('Erreur: ' + (data.error || 'Erreur inconnue'), 'error'); return; }
                row.classList.toggle('opacity-60', !data.is_visible);
                const serie = seriesData.find(s => s.serie_id === serieId);
                if (serie) serie.is_visible = data.is_visible;
                const visible = seriesData.filter(s => s.is_visible).length;
                document.getElementById('visible-series').textContent = visible;
                document.getElementById('hidden-series').textContent = seriesData.length - visible;
            })
            .catch(err => { toggle.classList.remove('loading'); checkbox.checked = !checkbox.checked; showToast('Erreur: ' + err.message, 'error'); });
    }

    function loadSets() {
        const loading = document.getElementById('visibility-loading');
        const setsView = document.getElementById('sets-view');
        loading.classList.remove('hidden');
        setsView.classList.add('hidden');

        fetch('/api/tcgdex/sets')
            .then(r => r.json())
            .then(data => {
                loading.classList.add('hidden');
                if (!data.success) { showToast('Erreur: ' + data.error, 'error'); return; }

                setsData = data.sets;
                dataLoaded.sets = true;
                const visible = setsData.filter(s => s.is_visible).length;
                document.getElementById('total-sets').textContent = setsData.length;
                document.getElementById('visible-sets').textContent = visible;
                document.getElementById('hidden-sets').textContent = setsData.length - visible;
                renderVisibilitySets();
                setsView.classList.remove('hidden');
            })
            .catch(err => { loading.classList.add('hidden'); showToast('Erreur: ' + err.message, 'error'); });
    }

    function renderVisibilitySets(filter = '') {
        const tbody = document.getElementById('visibility-sets-tbody');
        tbody.innerHTML = '';
        const filterLower = filter.toLowerCase();
        const filteredSets = setsData.filter(set => !filter || set.name.toLowerCase().includes(filterLower) || set.set_id.toLowerCase().includes(filterLower) || (set.serie_name && set.serie_name.toLowerCase().includes(filterLower)));

        filteredSets.forEach(set => {
            const tr = document.createElement('tr');
            let rowClass = 'hover:bg-gray-50 dark:hover:bg-dark-600/50';
            let badge = '';
            if (set.hidden_by_serie) {
                rowClass += ' opacity-40';
                badge = '<span class="ml-2 px-1.5 py-0.5 text-xs bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 rounded">série masquée</span>';
            } else if (!set.is_visible) {
                rowClass += ' opacity-60';
            }
            tr.className = rowClass;
            tr.id = `visibility-set-row-${set.set_id}`;
            tr.innerHTML = `
                <td class="px-4 py-3 font-mono text-sm text-gray-900 dark:text-white">${set.set_id}</td>
                <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">${set.name}${badge}</td>
                <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${set.serie_name || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300 text-right">${set.card_count || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${set.release_date || '-'}</td>
                <td class="px-4 py-3 text-center">
                    <label class="toggle-switch${set.hidden_by_serie ? ' loading' : ''}" id="toggle-set-${set.set_id}">
                        <input type="checkbox" ${set.is_visible ? 'checked' : ''} ${set.hidden_by_serie ? 'disabled' : ''} onchange="toggleSet('${set.set_id}')">
                        <span class="toggle-slider"></span>
                    </label>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function toggleSet(setId) {
        const toggle = document.getElementById(`toggle-set-${setId}`);
        const row = document.getElementById(`visibility-set-row-${setId}`);
        const checkbox = toggle.querySelector('input');
        toggle.classList.add('loading');

        fetch(`/api/tcgdex/sets/${setId}/toggle`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                toggle.classList.remove('loading');
                if (!data.success) { checkbox.checked = !checkbox.checked; showToast('Erreur: ' + (data.error || 'Erreur inconnue'), 'error'); return; }
                row.classList.toggle('opacity-60', !data.is_visible);
                const set = setsData.find(s => s.set_id === setId);
                if (set) set.is_visible = data.is_visible;
                const visible = setsData.filter(s => s.is_visible).length;
                document.getElementById('visible-sets').textContent = visible;
                document.getElementById('hidden-sets').textContent = setsData.length - visible;
            })
            .catch(err => { toggle.classList.remove('loading'); checkbox.checked = !checkbox.checked; showToast('Erreur: ' + err.message, 'error'); });
    }

    function filterSets() {
        renderVisibilitySets(document.getElementById('sets-filter').value);
    }

    function checkNewSets() {
        const btn = document.getElementById('check-btn');
        const loading = document.getElementById('loading');
        const result = document.getElementById('scan-result');

        btn.disabled = true;
        btn.textContent = 'Analyse en cours...';
        loading.classList.remove('hidden');
        result.classList.add('hidden');

        fetch('/api/tcgdex/check-new-sets')
            .then(r => r.json())
            .then(data => {
                loading.classList.add('hidden');
                result.classList.remove('hidden');
                btn.disabled = false;
                btn.textContent = 'Vérifier les nouveaux sets';

                if (!data.success) { showToast('Erreur: ' + data.error, 'error'); return; }

                document.getElementById('total-tcgdex').textContent = data.total_tcgdex_sets;
                document.getElementById('existing-sets').textContent = data.existing_sets;
                document.getElementById('imported-sets').textContent = data.imported_sets;
                document.getElementById('new-sets-count').textContent = data.new_count;

                newSets = data.new_sets;
                if (data.new_count > 0) {
                    document.getElementById('new-sets-list').classList.remove('hidden');
                    document.getElementById('no-new-sets').classList.add('hidden');
                    renderSetsList();
                } else {
                    document.getElementById('new-sets-list').classList.add('hidden');
                    document.getElementById('no-new-sets').classList.remove('hidden');
                }
            })
            .catch(err => { loading.classList.add('hidden'); btn.disabled = false; btn.textContent = 'Vérifier les nouveaux sets'; showToast('Erreur: ' + err.message, 'error'); });
    }

    function renderSetsList() {
        const tbody = document.getElementById('sets-tbody');
        tbody.innerHTML = '';
        newSets.forEach(set => {
            const tr = document.createElement('tr');
            tr.className = 'set-row hover:bg-gray-50 dark:hover:bg-dark-600/50';
            tr.id = `set-row-${set.id}`;
            tr.innerHTML = `
                <td class="px-4 py-3"><input type="checkbox" id="cb-${set.id}" onchange="updateImportBtn()" class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"></td>
                <td class="px-4 py-3 font-mono text-sm text-gray-900 dark:text-white">${set.id}</td>
                <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">${set.name}</td>
                <td class="px-4 py-3 text-sm text-gray-600 dark:text-gray-300 text-right">${set.card_count || '-'}</td>
                <td class="px-4 py-3 text-sm text-gray-500 dark:text-gray-400">${set.release_date || '-'}</td>
                <td class="px-4 py-3"><span class="status-badge px-2 py-1 text-xs font-medium rounded bg-gray-100 dark:bg-dark-600 text-gray-600 dark:text-gray-400" id="status-${set.id}">En attente</span></td>
            `;
            tbody.appendChild(tr);
        });
        updateImportBtn();
    }

    function toggleSelectAll() {
        allSelected = !allSelected;
        newSets.forEach(set => {
            const cb = document.getElementById(`cb-${set.id}`);
            if (cb && !cb.disabled) cb.checked = allSelected;
        });
        document.getElementById('select-all-text').textContent = allSelected ? 'Tout désélectionner' : 'Tout sélectionner';
        updateImportBtn();
    }

    function updateImportBtn() {
        const selected = getSelectedSetIds();
        const btn = document.getElementById('import-btn');
        btn.disabled = selected.length === 0;
        btn.textContent = selected.length > 0 ? `Importer ${selected.length} set${selected.length > 1 ? 's' : ''}` : 'Importer les sets sélectionnés';
    }

    function getSelectedSetIds() {
        return newSets.filter(set => { const cb = document.getElementById(`cb-${set.id}`); return cb && cb.checked; }).map(set => set.id);
    }

    async function importSelected() {
        const setIds = getSelectedSetIds();
        if (setIds.length === 0) return;

        const btn = document.getElementById('import-btn');
        btn.disabled = true;
        btn.textContent = 'Import en cours...';
        newSets.forEach(set => { const cb = document.getElementById(`cb-${set.id}`); if (cb) cb.disabled = true; });

        const resultsCard = document.getElementById('import-results');
        const resultsContent = document.getElementById('import-results-content');
        resultsCard.classList.remove('hidden');
        resultsContent.innerHTML = `
            <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-2 mb-4">
                <div class="h-2 rounded-full bg-blue-500 transition-all" id="progress-fill" style="width: 0%"></div>
            </div>
            <p id="progress-text" class="text-center text-gray-500 dark:text-gray-400">Import en cours: 0/${setIds.length}</p>
        `;

        let totalCreated = 0, totalUpdated = 0, errors = [];

        for (let i = 0; i < setIds.length; i++) {
            const setId = setIds[i];
            const statusBadge = document.getElementById(`status-${setId}`);
            const row = document.getElementById(`set-row-${setId}`);

            statusBadge.className = 'status-badge px-2 py-1 text-xs font-medium rounded bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400';
            statusBadge.textContent = 'Import...';
            row.classList.add('opacity-60');

            try {
                const response = await fetch(`/api/tcgdex/import-set/${setId}`, { method: 'POST' });
                const data = await response.json();

                if (data.success) {
                    statusBadge.className = 'status-badge px-2 py-1 text-xs font-medium rounded bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400';
                    statusBadge.textContent = `${data.cards_created} cartes`;
                    totalCreated += data.cards_created;
                    totalUpdated += data.cards_updated;
                } else {
                    statusBadge.className = 'status-badge px-2 py-1 text-xs font-medium rounded bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400';
                    statusBadge.textContent = 'Erreur';
                    errors.push({ setId, error: data.error });
                }
            } catch (err) {
                statusBadge.className = 'status-badge px-2 py-1 text-xs font-medium rounded bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400';
                statusBadge.textContent = 'Erreur';
                errors.push({ setId, error: err.message });
            }

            row.classList.remove('opacity-60');
            document.getElementById('progress-fill').style.width = `${((i + 1) / setIds.length) * 100}%`;
            document.getElementById('progress-text').textContent = `Import en cours: ${i + 1}/${setIds.length}`;
        }

        resultsContent.innerHTML = `
            <div class="grid grid-cols-3 gap-4">
                <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-green-600 dark:text-green-400">${totalCreated}</div>
                    <div class="text-sm text-green-600 dark:text-green-400">Cartes créées</div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/20 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-blue-600 dark:text-blue-400">${totalUpdated}</div>
                    <div class="text-sm text-blue-600 dark:text-blue-400">Cartes mises à jour</div>
                </div>
                <div class="bg-${errors.length > 0 ? 'red' : 'gray'}-50 dark:bg-${errors.length > 0 ? 'red' : 'gray'}-900/20 rounded-lg p-4 text-center">
                    <div class="text-2xl font-bold text-${errors.length > 0 ? 'red' : 'gray'}-600 dark:text-${errors.length > 0 ? 'red' : 'gray'}-400">${errors.length}</div>
                    <div class="text-sm text-${errors.length > 0 ? 'red' : 'gray'}-600 dark:text-${errors.length > 0 ? 'red' : 'gray'}-400">Erreurs</div>
                </div>
            </div>
            ${errors.length > 0 ? `
                <div class="mt-4 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                    <h4 class="font-medium text-red-600 dark:text-red-400 mb-2">Erreurs</h4>
                    <ul class="text-sm text-red-600 dark:text-red-400 space-y-1">
                        ${errors.map(e => `<li><strong>${e.setId}</strong>: ${e.error}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
        `;
        btn.textContent = 'Import terminé';
    }

    // === Export des annonces ===

    function loadExportSeries() {
        fetch('/api/tcgdex/series')
            .then(r => r.json())
            .then(data => {
                if (!data.success) return;
                exportSeriesData = data.series.filter(s => s.is_visible);
                const select = document.getElementById('export-series');
                exportSeriesData.forEach(serie => {
                    const opt = document.createElement('option');
                    opt.value = serie.serie_id;
                    opt.textContent = `${serie.serie_name} (${serie.set_count} sets)`;
                    select.appendChild(opt);
                });
            });
    }

    function onSeriesChange() {
        const serieId = document.getElementById('export-series').value;
        const container = document.getElementById('export-sets-container');

        if (!serieId) {
            container.innerHTML = '<span class="text-sm text-gray-500 dark:text-gray-400">Sélectionnez une série pour voir les sets</span>';
            return;
        }

        // Charger les sets de cette série
        fetch('/api/tcgdex/sets')
            .then(r => r.json())
            .then(data => {
                if (!data.success) return;
                const setsInSerie = data.sets.filter(s => s.serie_id === serieId && s.is_visible && !s.hidden_by_serie);

                if (setsInSerie.length === 0) {
                    container.innerHTML = '<span class="text-sm text-gray-500 dark:text-gray-400">Aucun set visible dans cette série</span>';
                    return;
                }

                container.innerHTML = setsInSerie.map(set => `
                    <label class="inline-flex items-center px-2 py-1 bg-white dark:bg-dark-700 rounded border border-gray-200 dark:border-dark-500 cursor-pointer hover:bg-gray-100 dark:hover:bg-dark-600">
                        <input type="checkbox" class="export-set-cb w-3 h-3 text-blue-600 border-gray-300 rounded" value="${set.set_id}">
                        <span class="ml-1.5 text-xs text-gray-700 dark:text-gray-300">${set.name}</span>
                    </label>
                `).join('');
            });
    }

    function exportListings() {
        const series = document.getElementById('export-series').value;
        const priceMin = document.getElementById('export-price-min').value;
        const priceMax = document.getElementById('export-price-max').value;

        // Récupérer les sets sélectionnés
        const selectedSets = Array.from(document.querySelectorAll('.export-set-cb:checked')).map(cb => cb.value);

        // Récupérer les types
        const types = [];
        if (document.getElementById('export-type-normal').checked) types.push('normal');
        if (document.getElementById('export-type-reverse').checked) types.push('reverse');
        if (document.getElementById('export-type-graded').checked) types.push('graded');

        if (types.length === 0) {
            showToast('Sélectionnez au moins un type d\'annonce', 'error');
            return;
        }

        // Construire l'URL
        const params = new URLSearchParams();
        if (series) params.set('series', series);
        if (selectedSets.length > 0) params.set('sets', selectedSets.join(','));
        if (priceMin) params.set('price_min', priceMin);
        if (priceMax) params.set('price_max', priceMax);
        params.set('types', types.join(','));

        // Télécharger
        window.location.href = '/export/listings?' + params.toString();
    }

    // Charger les séries pour l'export au chargement de la page
    document.addEventListener('DOMContentLoaded', function() {
        loadExportSeries();
    });
</script>
{% endblock %}
