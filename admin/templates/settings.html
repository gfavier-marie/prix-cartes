{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Settings</h1>
    <p class="text-gray-500 dark:text-gray-400 mt-1">Configuration du batch automatique et de l'API eBay</p>
</div>

<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Batch automatique -->
    <div class="bg-white dark:bg-dark-700 rounded-lg shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Batch automatique</h2>
        <form method="POST" action="{{ url_for('settings_save') }}" class="space-y-5">
            <!-- Batch actif -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Batch actif</label>
                <div class="flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="batch_enabled" value="true"
                               {% if settings.batch_enabled.value == 'true' %}checked{% endif %}
                               class="w-4 h-4 text-blue-600 border-gray-300 dark:border-dark-500 focus:ring-blue-500">
                        <span class="px-2 py-1 text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded">Actif</span>
                    </label>
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="radio" name="batch_enabled" value="false"
                               {% if settings.batch_enabled.value != 'true' %}checked{% endif %}
                               class="w-4 h-4 text-blue-600 border-gray-300 dark:border-dark-500 focus:ring-blue-500">
                        <span class="px-2 py-1 text-xs font-medium bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-400 rounded">Inactif</span>
                    </label>
                </div>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Si actif, le batch s'exécutera automatiquement chaque jour</p>
            </div>

            <!-- Heure d'exécution -->
            <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Heure d'exécution</label>
                <div class="flex items-center gap-2">
                    <input type="number" name="batch_hour" value="{{ settings.batch_hour.value }}" min="0" max="23" step="1"
                           class="w-20 px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-300 dark:border-dark-500 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                    <span class="text-gray-500 dark:text-gray-400">h</span>
                    <input type="number" name="batch_minute" value="{{ settings.batch_minute.value if settings.batch_minute else '0' }}" min="0" max="59" step="1"
                           class="w-20 px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-300 dark:border-dark-500 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                    <span class="text-gray-500 dark:text-gray-400">min</span>
                </div>
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Le batch sera lancé à cette heure (heure serveur)</p>
            </div>

            <!-- Limite API -->
            <div>
                <label for="daily_api_limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Limite quotidienne d'appels API</label>
                <input type="number" id="daily_api_limit" name="daily_api_limit" value="{{ settings.daily_api_limit.value }}" min="0" step="100"
                       class="w-36 px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-300 dark:border-dark-500 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Le batch s'arrêtera automatiquement si cette limite est atteinte</p>
            </div>

            <!-- Section Priorisation -->
            <div class="pt-4 border-t border-gray-200 dark:border-dark-600">
                <h3 class="text-sm font-medium text-gray-600 dark:text-gray-400 mb-4">Priorisation des cartes</h3>

                <div class="space-y-4">
                    <div>
                        <label for="low_value_threshold" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Seuil basse valeur (euros)</label>
                        <input type="number" id="low_value_threshold" name="low_value_threshold"
                               value="{{ settings.low_value_threshold.value if settings.low_value_threshold else '10' }}" min="0" step="0.5"
                               class="w-28 px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-300 dark:border-dark-500 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Les cartes sous ce seuil sont rafraîchies moins souvent</p>
                    </div>

                    <div>
                        <label for="low_value_refresh_days" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Fréquence basse valeur (jours)</label>
                        <input type="number" id="low_value_refresh_days" name="low_value_refresh_days"
                               value="{{ settings.low_value_refresh_days.value if settings.low_value_refresh_days else '60' }}" min="1" step="1"
                               class="w-28 px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-300 dark:border-dark-500 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Cartes &lt; seuil = rafraîchies tous les X jours</p>
                    </div>

                    <div>
                        <label for="max_error_retries" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Max erreurs consécutives</label>
                        <input type="number" id="max_error_retries" name="max_error_retries"
                               value="{{ settings.max_error_retries.value if settings.max_error_retries else '3' }}" min="1" step="1"
                               class="w-28 px-3 py-2 bg-gray-50 dark:bg-dark-600 border border-gray-300 dark:border-dark-500 rounded-lg text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500">
                        <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Après X erreurs, la carte passe en basse priorité</p>
                    </div>
                </div>
            </div>

            <button type="submit" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors">
                Sauvegarder
            </button>
        </form>
    </div>

    <!-- Usage API -->
    <div class="bg-white dark:bg-dark-700 rounded-lg shadow-sm p-6">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Usage API eBay</h2>
        {% if ebay_usage %}
        <div class="space-y-4">
            <!-- Progress bar -->
            <div>
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm text-gray-600 dark:text-gray-400">Appels aujourd'hui</span>
                    <span class="text-sm font-medium text-gray-900 dark:text-white">{{ ebay_usage.count or 0 }} / {{ ebay_usage.limit or 5000 }}</span>
                </div>
                <div class="w-full bg-gray-200 dark:bg-dark-600 rounded-full h-3">
                    <div class="h-3 rounded-full transition-all {% if ebay_usage.percent > 80 %}bg-red-500{% elif ebay_usage.percent > 50 %}bg-yellow-500{% else %}bg-green-500{% endif %}"
                         style="width: {{ ebay_usage.percent }}%"></div>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div class="bg-gray-50 dark:bg-dark-600 rounded-lg p-4">
                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase">Utilisés</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ ebay_usage.count or 0 }}</p>
                </div>
                <div class="bg-gray-50 dark:bg-dark-600 rounded-lg p-4">
                    <p class="text-xs text-gray-500 dark:text-gray-400 uppercase">Restants</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-white">{{ ebay_usage.remaining or 0 }}</p>
                </div>
            </div>

            {% if ebay_usage.reset_formatted %}
            <div class="flex items-center justify-between text-sm">
                <span class="text-gray-500 dark:text-gray-400">Reset</span>
                <span class="text-gray-900 dark:text-white">{{ ebay_usage.reset_formatted }}</span>
            </div>
            {% endif %}

            <div class="pt-2">
                <span class="px-2 py-1 text-xs font-medium rounded
                    {% if ebay_usage.percent > 80 %}bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400
                    {% elif ebay_usage.percent > 50 %}bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400
                    {% else %}bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400{% endif %}">
                    {{ ebay_usage.percent }}% utilisé
                </span>
            </div>
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-500 dark:text-gray-400">
            <svg class="w-12 h-12 mx-auto mb-3 text-gray-300 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
            </svg>
            <p>Impossible de récupérer les données eBay</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Informations -->
<div class="bg-white dark:bg-dark-700 rounded-lg shadow-sm p-6">
    <h2 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Informations</h2>

    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
        Le batch automatique est exécuté par cron toutes les minutes. Il vérifie si :
    </p>
    <ul class="text-sm text-gray-600 dark:text-gray-400 space-y-1 ml-5 list-disc mb-6">
        <li>Le batch est activé (toggle ci-dessus)</li>
        <li>C'est l'heure et la minute configurées</li>
        <li>La limite quotidienne d'appels API n'est pas atteinte</li>
    </ul>

    <h3 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Ordre de priorité des cartes</h3>
    <ol class="text-sm text-gray-600 dark:text-gray-400 space-y-2 ml-5 list-decimal">
        <li><span class="font-medium text-gray-900 dark:text-white">Cartes jamais explorées</span> — toujours en premier</li>
        <li><span class="font-medium text-gray-900 dark:text-white">Cartes en erreur</span> (&lt; max erreurs) — cooldown 24h</li>
        <li><span class="font-medium text-gray-900 dark:text-white">Cartes basse valeur</span> (&lt; seuil) ou <span class="font-medium text-gray-900 dark:text-white">trop d'erreurs</span> — rafraîchies tous les X jours</li>
        <li><span class="font-medium text-gray-900 dark:text-white">Autres cartes</span> — par ancienneté (plus anciennes d'abord)</li>
    </ol>

    <p class="text-sm text-gray-600 dark:text-gray-400 mt-4">
        Les logs du batch sont disponibles dans <code class="px-1.5 py-0.5 bg-gray-100 dark:bg-dark-600 rounded text-xs font-mono">/var/log/batch.log</code> (en production Docker).
    </p>
</div>
{% endblock %}
