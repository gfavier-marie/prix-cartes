{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Settings</h1>
    <p>Configuration du batch automatique et de l'API eBay</p>
</div>

<div class="info-grid">
    <div class="card">
        <h2>Batch automatique</h2>
        <form method="POST" action="{{ url_for('settings_save') }}">
            <div class="form-group">
                <label>Batch actif</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="batch_enabled" value="true"
                               {% if settings.batch_enabled.value == 'true' %}checked{% endif %}
                               style="width: auto;">
                        <span class="badge badge-ok">Actif</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="batch_enabled" value="false"
                               {% if settings.batch_enabled.value != 'true' %}checked{% endif %}
                               style="width: auto;">
                        <span class="badge badge-disabled">Inactif</span>
                    </label>
                </div>
                <small class="text-muted">Si actif, le batch s'executera automatiquement chaque jour</small>
            </div>

            <div class="form-group">
                <label>Heure d'execution</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" id="batch_hour" name="batch_hour"
                           value="{{ settings.batch_hour.value }}"
                           min="0" max="23" step="1"
                           style="max-width: 80px;">
                    <span>h</span>
                    <input type="number" id="batch_minute" name="batch_minute"
                           value="{{ settings.batch_minute.value if settings.batch_minute else '0' }}"
                           min="0" max="59" step="1"
                           style="max-width: 80px;">
                    <span>min</span>
                </div>
                <small class="text-muted">Le batch sera lance a cette heure (heure serveur)</small>
            </div>

            <div class="form-group">
                <label for="daily_api_limit">Limite quotidienne d'appels API</label>
                <input type="number" id="daily_api_limit" name="daily_api_limit"
                       value="{{ settings.daily_api_limit.value }}"
                       min="0" step="100"
                       style="max-width: 150px;">
                <small class="text-muted">Le batch s'arretera automatiquement si cette limite est atteinte</small>
            </div>

            <button type="submit" class="btn btn-primary">Sauvegarder</button>
        </form>
    </div>

    <div class="card">
        <h2>Usage API eBay</h2>
        <table class="info-table">
            <tr>
                <td>Appels aujourd'hui</td>
                <td>
                    <span class="price price-main">{{ api_usage.today_count or 0 }}</span>
                    / {{ api_usage.daily_limit or settings.daily_api_limit.value }}
                </td>
            </tr>
            <tr>
                <td>Restants</td>
                <td>{{ api_usage.remaining or (settings.daily_api_limit.value|int - (api_usage.today_count or 0)) }}</td>
            </tr>
            {% if api_usage.ebay_count is defined %}
            <tr>
                <td>eBay (reel)</td>
                <td>{{ api_usage.ebay_count }} / {{ api_usage.ebay_limit }}</td>
            </tr>
            {% endif %}
            {% if api_usage.ebay_reset_formatted %}
            <tr>
                <td>Reset</td>
                <td>{{ api_usage.ebay_reset_formatted }}</td>
            </tr>
            {% endif %}
        </table>

        <div style="margin-top: 20px;">
            <button class="btn btn-ghost btn-sm" onclick="refreshUsage()">
                Rafraichir depuis eBay
            </button>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 24px;">
    <h2>Informations</h2>
    <p class="text-secondary">
        Le batch automatique est execute par cron toutes les minutes. Il verifie si:
    </p>
    <ul class="text-secondary" style="margin: 12px 0 0 20px; line-height: 1.8;">
        <li>Le batch est active (toggle ci-dessus)</li>
        <li>C'est l'heure et la minute configurees</li>
        <li>La limite quotidienne d'appels API n'est pas atteinte</li>
    </ul>
    <p class="text-secondary" style="margin-top: 12px;">
        Les logs du batch sont disponibles dans <code class="mono">/var/log/batch.log</code> (en production Docker).
    </p>
</div>

<script>
function refreshUsage() {
    fetch('/api/usage/ebay/refresh', { method: 'POST' })
        .then(r => r.json())
        .then(() => location.reload())
        .catch(e => alert('Erreur: ' + e));
}
</script>
{% endblock %}
