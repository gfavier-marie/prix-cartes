{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Settings</h1>
    <p>Configuration du batch automatique et de l'API eBay</p>
</div>

<div class="info-grid">
    <div class="card">
        <h2>Batch automatique</h2>
        <form method="POST" action="{{ url_for('settings_save') }}">
            <div class="form-group">
                <label>Batch actif</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="batch_enabled" value="true"
                               {% if settings.batch_enabled.value == 'true' %}checked{% endif %}
                               style="width: auto;">
                        <span class="badge badge-ok">Actif</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="radio" name="batch_enabled" value="false"
                               {% if settings.batch_enabled.value != 'true' %}checked{% endif %}
                               style="width: auto;">
                        <span class="badge badge-disabled">Inactif</span>
                    </label>
                </div>
                <small class="text-muted">Si actif, le batch s'executera automatiquement chaque jour</small>
            </div>

            <div class="form-group">
                <label>Heure d'execution</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <input type="number" id="batch_hour" name="batch_hour"
                           value="{{ settings.batch_hour.value }}"
                           min="0" max="23" step="1"
                           style="max-width: 80px;">
                    <span>h</span>
                    <input type="number" id="batch_minute" name="batch_minute"
                           value="{{ settings.batch_minute.value if settings.batch_minute else '0' }}"
                           min="0" max="59" step="1"
                           style="max-width: 80px;">
                    <span>min</span>
                </div>
                <small class="text-muted">Le batch sera lance a cette heure (heure serveur)</small>
            </div>

            <div class="form-group">
                <label for="daily_api_limit">Limite quotidienne d'appels API</label>
                <input type="number" id="daily_api_limit" name="daily_api_limit"
                       value="{{ settings.daily_api_limit.value }}"
                       min="0" step="100"
                       style="max-width: 150px;">
                <small class="text-muted">Le batch s'arretera automatiquement si cette limite est atteinte</small>
            </div>

            <h3 style="margin-top: 24px; margin-bottom: 16px; color: var(--text-secondary);">Priorisation des cartes</h3>

            <div class="form-group">
                <label for="low_value_threshold">Seuil basse valeur (euros)</label>
                <input type="number" id="low_value_threshold" name="low_value_threshold"
                       value="{{ settings.low_value_threshold.value if settings.low_value_threshold else '10' }}"
                       min="0" step="0.5"
                       style="max-width: 120px;">
                <small class="text-muted">Les cartes sous ce seuil sont rafraichies moins souvent</small>
            </div>

            <div class="form-group">
                <label for="low_value_refresh_days">Frequence basse valeur (jours)</label>
                <input type="number" id="low_value_refresh_days" name="low_value_refresh_days"
                       value="{{ settings.low_value_refresh_days.value if settings.low_value_refresh_days else '60' }}"
                       min="1" step="1"
                       style="max-width: 120px;">
                <small class="text-muted">Cartes < seuil = rafraichies tous les X jours (ex: 60 = tous les 2 mois)</small>
            </div>

            <div class="form-group">
                <label for="max_error_retries">Max erreurs consecutives</label>
                <input type="number" id="max_error_retries" name="max_error_retries"
                       value="{{ settings.max_error_retries.value if settings.max_error_retries else '3' }}"
                       min="1" step="1"
                       style="max-width: 120px;">
                <small class="text-muted">Apres X erreurs, la carte passe en basse priorite (meme frequence que basse valeur)</small>
            </div>

            <button type="submit" class="btn btn-primary">Sauvegarder</button>
        </form>
    </div>

    <div class="card">
        <h2>Usage API eBay</h2>
        {% if ebay_usage %}
        <table class="info-table">
            <tr>
                <td>Appels</td>
                <td>
                    <span class="price price-main">{{ ebay_usage.count or 0 }}</span>
                    / {{ ebay_usage.limit or 5000 }}
                    <span class="badge {% if ebay_usage.percent > 80 %}badge-error{% elif ebay_usage.percent > 50 %}badge-warning{% else %}badge-ok{% endif %}" style="margin-left: 8px;">{{ ebay_usage.percent }}%</span>
                </td>
            </tr>
            <tr>
                <td>Restants</td>
                <td>{{ ebay_usage.remaining or 0 }}</td>
            </tr>
            {% if ebay_usage.reset_formatted %}
            <tr>
                <td>Reset</td>
                <td>{{ ebay_usage.reset_formatted }}</td>
            </tr>
            {% endif %}
        </table>
        {% else %}
        <p class="text-secondary">Impossible de recuperer les donnees eBay</p>
        {% endif %}
    </div>
</div>

<div class="card" style="margin-top: 24px;">
    <h2>Informations</h2>
    <p class="text-secondary">
        Le batch automatique est execute par cron toutes les minutes. Il verifie si:
    </p>
    <ul class="text-secondary" style="margin: 12px 0 0 20px; line-height: 1.8;">
        <li>Le batch est active (toggle ci-dessus)</li>
        <li>C'est l'heure et la minute configurees</li>
        <li>La limite quotidienne d'appels API n'est pas atteinte</li>
    </ul>

    <h3 style="margin-top: 20px; color: var(--text-secondary);">Ordre de priorite des cartes</h3>
    <ol class="text-secondary" style="margin: 12px 0 0 20px; line-height: 1.8;">
        <li><strong>Cartes jamais explorees</strong> - toujours en premier</li>
        <li><strong>Cartes en erreur</strong> (< max erreurs) - cooldown 24h</li>
        <li><strong>Cartes basse valeur</strong> (< seuil) ou <strong>trop d'erreurs</strong> - rafraichies tous les X jours</li>
        <li><strong>Autres cartes</strong> - par anciennete (plus anciennes d'abord)</li>
    </ol>

    <p class="text-secondary" style="margin-top: 12px;">
        Les logs du batch sont disponibles dans <code class="mono">/var/log/batch.log</code> (en production Docker).
    </p>
</div>

{% endblock %}
